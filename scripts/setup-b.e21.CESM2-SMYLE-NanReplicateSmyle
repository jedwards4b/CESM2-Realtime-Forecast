#!/bin/csh -fx

# Script to set up cases for TBI Pacemaker Experiments based on SMYLE 

### set env variables
setenv CESM2_TOOLS_ROOT /glade/work/nanr/cesm_tags/CASE_tools/cesm2-smyle/
setenv CESMROOT /glade/work/nanr/cesm_tags/cesm2.1.4-SMYLE
set COMPSET = BSMYLE
set MACHINE = cheyenne
set RESOLN = f09_g17
set RESUBMIT = 0
set STOP_N=2
set STOP_OPTION=nmonths
set PROJECT=CESM0021
setenv BASEROOT /glade/scratch/nanr/SMYLE-PACEMAKER/TEST/
setenv SRCPOPROOT /glade/work/yeager/cesm_runs/cesm2.x_B_cases/CLIVAR_TBI_hindcastpacemaker/TBIpacemaker_srcmods/
setenv PTINTMASKFILE /glade/work/yeager/cesm_runs/cesm2.x_B_cases/CLIVAR_TBI_hindcastpacemaker/data/TBI_Atlantic_mask_10S-10N.nc
setenv PTINTSSTFILEBASE /glade/work/yeager/cesm_runs/cesm2.x_B_cases/CLIVAR_TBI_hindcastpacemaker/data/SMYLE_anom-restore_SST/TBI_SST.POPg17
set PTINTTAU = 2

### Set start years to loop over
set syr = 1997
set eyr = 1997
@ ib = $syr
@ ie = $eyr

foreach year ( `seq $ib $ie` )

@ lastyear= ${year} + 2 

### Set start months to loop over
#foreach mon ( 02 05 08 11 )
foreach mon ( 02 )

### Set corresponding SMYLE reference case for this year/month to get initial conditions
set REFCASE  = b.e21.SMYLE_IC.f09_g17.${year}-${mon}.01
set REFROOT  = /glade/p/cesm/espwg/CESM2-SMYLE/inputdata/cesm2_init/${REFCASE}

### Set target SST dataset for this case
setenv PTINTSSTFILE ${PTINTSSTFILEBASE}.${year}-${mon}.nc

### Set members to loop over
set smbr =  1
set embr =  1
@ mb = $smbr
@ me = $embr

foreach mbr ( `seq $mb $me` )

if ($mbr < 10) then
        set mem = 0${mbr}
else
        set mem = ${mbr}
endif

### Here is where case name is defined
#set CASE = b.e21.BSMYLE.f09_g17.TBI-ATL_5day.${year}-${mon}.0${mem}
#set CASE = b.e21.BSMYLE.f09_g17.TBI-ATL_10day.${year}-${mon}.0${mem}
#set CASE = b.e21.BSMYLE.f09_g17.TBI-ATL_5day_anom.${year}-${mon}.0${mem}
set CASE = b.e21.BSMYLE.f09_g17.REPLICATE-SMYLE.${year}-${mon}.0${mem}

cd $CESMROOT/cime/scripts
./create_newcase --case $BASEROOT$CASE --res $RESOLN  --compset $COMPSET --project $PROJECT

echo 'Year   = ' $year
echo 'Member = ' $mem
echo 'Case   = ' $CASE

setenv RUNDIR   /glade/scratch/$USER/$CASE/run
setenv CASEROOT  $BASEROOT$CASE
cd $CASEROOT
### case env settings
./xmlchange OCN_TRACER_MODULES="iage cfc ecosys"
./xmlchange CCSM_BGC="CO2A"
./xmlchange OCN_CHL_TYPE=diagnostic
./xmlchange RUN_REFCASE=$REFCASE
./xmlchange RUN_REFDATE=${year}-${mon}-01
./xmlchange RUN_STARTDATE=${year}-${mon}-01
./xmlchange GET_REFCASE=FALSE
./xmlchange PROJECT=${PROJECT}
./xmlchange --append CAM_CONFIG_OPTS=-cosp
#./xmlchange NTASKS_ICE=36
#./xmlchange NTASKS_LND=504
#./xmlchange ROOTPE_ICE=504
./xmlchange NTASKS_ICE=72
./xmlchange NTASKS_LND=468
./xmlchange ROOTPE_ICE=468
# ./xmlchange DOUT_S_ROOT=$ENV{SCRATCH}/SMYLE/archive/$CASE

./case.setup

### Copy over sourcemods for SMYLE, along with sourcmods for TBI pacemaker 
cp $CESM2_TOOLS_ROOT/user_mods/cesm2smyle.base/SourceMods/src.pop/* $CASEROOT/SourceMods/src.pop/
cp $CESM2_TOOLS_ROOT/user_mods/cesm2smyle.base/SourceMods/src.cam/* $CASEROOT/SourceMods/src.cam/
cp $CESM2_TOOLS_ROOT/user_mods/cesm2smyle.base/SourceMods/src.clm/* $CASEROOT/SourceMods/src.clm/
cp $CESM2_TOOLS_ROOT/user_mods/cesm2smyle.base/user_nl_* $CASEROOT/
# cp $SRCPOPROOT/*.F90 $CASEROOT/SourceMods/src.pop/

### POP namelist mods need special attention
#cp -f $SRCPOPROOT/user_nl_pop $CASEROOT/user_nl_pop
#echo "pt_interior_restore_filename = '$PTINTMASKFILE'" >> $CASEROOT/user_nl_pop
#echo "pt_interior_restore_tau = $PTINTTAU" >> $CASEROOT/user_nl_pop
#echo "pt_interior_shr_stream_file = '$PTINTSSTFILE'" >> $CASEROOT/user_nl_pop
#echo "pt_interior_shr_stream_year_align = ${year}" >> $CASEROOT/user_nl_pop
#echo "pt_interior_shr_stream_year_first = ${year}" >> $CASEROOT/user_nl_pop
#echo "pt_interior_shr_stream_year_last = ${lastyear}" >> $CASEROOT/user_nl_pop

### POP output modified to include TEMP_RESTORE fields
#cp -f $SRCPOPROOT/gx1v7_tavg_contents $CASEROOT/SourceMods/src.pop/

### More case env settings
./xmlchange STOP_N=$STOP_N
./xmlchange STOP_OPTION=$STOP_OPTION
./xmlchange RESUBMIT=$RESUBMIT

### Retrieve needed restart files
### Use restarts for case 001 for all ensemble members; if mbr>1, pertlim will differentiate runs.
echo " Copy Restarts -------------"
if (! -d $RUNDIR) then
        echo 'mkdir ' $RUNDIR
        mkdir -p $RUNDIR
endif
set RESTARTDIR = ${REFROOT}/${year}-${mon}-01
cp    ${RESTARTDIR}/rpointer* $RUNDIR/
ln -s ${RESTARTDIR}/b.e21*    $RUNDIR/
if ($mbr > 1) then
        set PERTDIR = ${REFROOT}/pert.${mem}
        rm -f $RUNDIR/*.cam.i.*.nc
        ln -s ${PERTDIR}/b.e21*    $RUNDIR/b.e21.SMYLE_IC.f09_g17.${year}-${mon}.01.cam.i.${year}-${mon}-01-00000.nc
endif

echo " End restarts copy -----------"

#echo $RUNDIR

# ./preview_namelists

# qcmd -- ./case.build >& bld.`date +%m%d-%H%M`
end             # member loop

exit

